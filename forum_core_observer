// Forum Core Observer - 100% Always Available Version
(function() {
    'use strict';
    
    // Store callbacks that try to register before observer is ready
    var pendingRegistrations = [];
    var pendingDebouncedRegistrations = [];
    
    // Create the actual observer class
    var ForumCoreObserver = function() {
        // Core registry
        this.callbacks = [];
        this.debouncedCallbacks = [];
        
        // Performance tracking
        this.debounceTimeouts = new Map();
        this.processedNodes = new WeakSet();
        this.mutationMetrics = {
            totalMutations: 0,
            processedMutations: 0,
            averageProcessingTime: 0,
            lastMutationTime: 0
        };
        
        // Configuration
        this.config = {
            observerOptions: {
                childList: true,
                subtree: true,
                characterData: true,
                attributes: true,
                attributeFilter: ['class', 'id', 'style', 'data-*']
            },
            performance: {
                maxProcessingTime: 16,
                mutationBatchSize: 50,
                debounceThreshold: 100,
                idleCallbackTimeout: 2000
            }
        };
        
        // State
        this.observer = null;
        this.mutationQueue = [];
        this.isProcessing = false;
        this.pageState = null;
        this.initialScanComplete = false;
        this.initialized = false;
    };
    
    ForumCoreObserver.prototype.init = function() {
        if (this.initialized) return;
        
        try {
            this.pageState = this.detectPageState();
            this.observer = new MutationObserver(this.handleMutations.bind(this));
            this.observer.observe(document.documentElement, this.config.observerOptions);
            this.scanExistingContent();
            this.initialized = true;
            
            console.log('âœ… Forum Core Observer initialized');
            
            // Process any pending registrations
            this.processPendingRegistrations();
            
        } catch (error) {
            console.error('Observer init error:', error);
        }
    };
    
    ForumCoreObserver.prototype.detectPageState = function() {
        var path = window.location.pathname;
        return {
            isForum: path.indexOf('/f/') !== -1 || !!document.querySelector('.board, .big_list'),
            isTopic: path.indexOf('/t/') !== -1 || !!document.querySelector('.modern-topic-title'),
            isBlog: path.indexOf('/b/') !== -1 || !!document.querySelector('#blog, .article'),
            isProfile: path.indexOf('/user/') !== -1 || !!document.querySelector('.modern-profile'),
            isSearch: path.indexOf('/search/') !== -1 || !!document.querySelector('#search.posts')
        };
    };
    
    ForumCoreObserver.prototype.handleMutations = function(mutations) {
        if (!this.initialized) return;
        
        for (var i = 0; i < mutations.length; i++) {
            this.mutationQueue.push(mutations[i]);
        }
        
        if (!this.isProcessing) {
            this.processMutations();
        }
    };
    
    ForumCoreObserver.prototype.processMutations = function() {
        var self = this;
        self.isProcessing = true;
        
        function processBatch() {
            if (self.mutationQueue.length === 0) {
                self.isProcessing = false;
                return;
            }
            
            var batch = self.mutationQueue.splice(0, self.config.performance.mutationBatchSize);
            self.processBatch(batch);
            
            if (self.mutationQueue.length > 0) {
                setTimeout(processBatch, 0);
            } else {
                self.isProcessing = false;
            }
        }
        
        processBatch();
    };
    
    ForumCoreObserver.prototype.processBatch = function(mutations) {
        var affectedNodes = new Set();
        
        for (var i = 0; i < mutations.length; i++) {
            var mutation = mutations[i];
            
            if (mutation.type === 'childList') {
                for (var j = 0; j < mutation.addedNodes.length; j++) {
                    var node = mutation.addedNodes[j];
                    if (node.nodeType === 1) {
                        this.collectNodes(node, affectedNodes);
                    }
                }
            } else if (mutation.type === 'attributes') {
                affectedNodes.add(mutation.target);
            }
        }
        
        var nodes = Array.from(affectedNodes);
        for (var k = 0; k < nodes.length; k++) {
            var node = nodes[k];
            if (node && !this.processedNodes.has(node)) {
                this.processNode(node);
                this.processedNodes.add(node);
            }
        }
    };
    
    ForumCoreObserver.prototype.collectNodes = function(root, collection) {
        if (!root || root.nodeType !== 1) return;
        collection.add(root);
        
        for (var i = 0; i < root.children.length; i++) {
            this.collectNodes(root.children[i], collection);
        }
    };
    
    ForumCoreObserver.prototype.processNode = function(node) {
        if (!node || node.nodeType !== 1) return;
        
        for (var i = 0; i < this.callbacks.length; i++) {
            var callback = this.callbacks[i];
            if (!callback.selector || node.matches(callback.selector) || node.querySelector(callback.selector)) {
                try {
                    callback.fn(node);
                } catch (error) {
                    console.error('Callback error:', error);
                }
            }
        }
    };
    
    ForumCoreObserver.prototype.scanExistingContent = function() {
        var self = this;
        var selectors = ['.post', '.article', '.btn', '.modern-quote', '.modern-profile'];
        
        for (var i = 0; i < selectors.length; i++) {
            try {
                var elements = document.querySelectorAll(selectors[i]);
                for (var j = 0; j < elements.length; j++) {
                    if (!self.processedNodes.has(elements[j])) {
                        self.processNode(elements[j]);
                        self.processedNodes.add(elements[j]);
                    }
                }
            } catch (error) {
                // Ignore selector errors
            }
        }
        
        this.initialScanComplete = true;
    };
    
    ForumCoreObserver.prototype.processPendingRegistrations = function() {
        // Process pending immediate registrations
        for (var i = 0; i < pendingRegistrations.length; i++) {
            this.register(pendingRegistrations[i]);
        }
        pendingRegistrations.length = 0;
        
        // Process pending debounced registrations
        for (var j = 0; j < pendingDebouncedRegistrations.length; j++) {
            this.registerDebounced(pendingDebouncedRegistrations[j]);
        }
        pendingDebouncedRegistrations.length = 0;
    };
    
    ForumCoreObserver.prototype.register = function(settings) {
        if (!this.initialized) {
            pendingRegistrations.push(settings);
            return 'pending_' + Date.now();
        }
        
        var id = settings.id || 'cb_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
        
        this.callbacks.push({
            id: id,
            fn: settings.callback,
            priority: settings.priority || 'normal',
            selector: settings.selector,
            pageTypes: settings.pageTypes
        });
        
        // Run on existing elements
        if (this.initialScanComplete && settings.selector) {
            try {
                var elements = document.querySelectorAll(settings.selector);
                for (var i = 0; i < elements.length; i++) {
                    if (!this.processedNodes.has(elements[i])) {
                        settings.callback(elements[i]);
                    }
                }
            } catch (error) {
                // Ignore
            }
        }
        
        return id;
    };
    
    ForumCoreObserver.prototype.registerDebounced = function(settings) {
        return this.register(settings);
    };
    
    ForumCoreObserver.prototype.unregister = function(id) {
        for (var i = 0; i < this.callbacks.length; i++) {
            if (this.callbacks[i].id === id) {
                this.callbacks.splice(i, 1);
                return true;
            }
        }
        return false;
    };
    
    ForumCoreObserver.prototype.forceScan = function(selector) {
        if (!selector) {
            this.scanExistingContent();
            return;
        }
        
        try {
            var elements = document.querySelectorAll(selector);
            for (var i = 0; i < elements.length; i++) {
                if (!this.processedNodes.has(elements[i])) {
                    this.processNode(elements[i]);
                }
            }
        } catch (error) {
            // Ignore
        }
    };
    
    ForumCoreObserver.prototype.getStats = function() {
        return {
            initialized: this.initialized,
            callbacks: this.callbacks.length,
            processedNodes: this.processedNodes.size,
            pendingRegistrations: pendingRegistrations.length
        };
    };
    
    ForumCoreObserver.prototype.destroy = function() {
        if (this.observer) {
            this.observer.disconnect();
        }
        this.initialized = false;
    };
    
    // ============================================
    // GLOBAL SETUP - This runs immediately
    // ============================================
    
    // Create the global object immediately
    window.forumObserver = {
        // Safe placeholder methods - will be replaced when real observer is ready
        register: function(settings) {
            console.log('â³ Observer not ready, queuing registration:', settings.id || 'unnamed');
            pendingRegistrations.push(settings);
            return 'queued_' + Date.now();
        },
        
        registerDebounced: function(settings) {
            console.log('â³ Observer not ready, queuing debounced registration:', settings.id || 'unnamed');
            pendingDebouncedRegistrations.push(settings);
            return 'queued_debounced_' + Date.now();
        },
        
        unregister: function(id) {
            console.log('â³ Observer not ready, cannot unregister:', id);
            return false;
        },
        
        forceScan: function(selector) {
            console.log('â³ Observer not ready, cannot force scan');
        },
        
        getStats: function() {
            return {
                status: 'initializing',
                pendingRegistrations: pendingRegistrations.length,
                pendingDebouncedRegistrations: pendingDebouncedRegistrations.length,
                message: 'Observer will be ready soon'
            };
        },
        
        destroy: function() {
            console.log('Observer not yet initialized');
        },
        
        init: function() {
            console.log('Manual init requested');
        }
    };
    
    // Create real observer instance
    var realObserver = new ForumCoreObserver();
    
    // Replace placeholder methods when observer is ready
    var originalRegister = window.forumObserver.register;
    var originalRegisterDebounced = window.forumObserver.registerDebounced;
    var originalUnregister = window.forumObserver.unregister;
    var originalForceScan = window.forumObserver.forceScan;
    var originalGetStats = window.forumObserver.getStats;
    var originalDestroy = window.forumObserver.destroy;
    
    // Initialize when DOM is ready
    function initializeObserver() {
        realObserver.init();
        
        // Replace placeholder methods with real ones
        window.forumObserver.register = function(settings) {
            return realObserver.register(settings);
        };
        
        window.forumObserver.registerDebounced = function(settings) {
            return realObserver.registerDebounced(settings);
        };
        
        window.forumObserver.unregister = function(id) {
            return realObserver.unregister(id);
        };
        
        window.forumObserver.forceScan = function(selector) {
            return realObserver.forceScan(selector);
        };
        
        window.forumObserver.getStats = function() {
            return realObserver.getStats();
        };
        
        window.forumObserver.destroy = function() {
            return realObserver.destroy();
        };
        
        window.forumObserver.init = function() {
            // Already initialized
        };
        
        console.log('âœ… Forum Core Observer READY - All queued callbacks processed');
    }
    
    // Start initialization
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeObserver);
    } else {
        setTimeout(initializeObserver, 100);
    }
    
    // Helper functions for easy access
    window.registerForumScript = function(settings) {
        return window.forumObserver.register(settings);
    };
    
    window.registerDebouncedForumScript = function(settings) {
        return window.forumObserver.registerDebounced(settings);
    };
    
    console.log('ðŸŽ¯ Forum Core Observer LOADED - API available immediately');
    
})();
